<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Passwort-Eingabe UX Studie</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      line-height: 1.5;
    }
    
    .container {
      width: 100%;
      max-width: 36rem;
    }
    
    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.15);
    }
    
    .screen { display: none; }
    .screen.active { display: block; }
    
    .text-center { text-align: center; }
    
    .badge {
      display: inline-block;
      padding: 0.375rem 1rem;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 9999px;
      color: #60a5fa;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    
    h1 {
      color: white;
      font-size: 1.875rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    h2 {
      color: white;
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    h3 {
      color: #60a5fa;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    
    p {
      color: #94a3b8;
    }
    
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 1.5rem 0;
    }
    
    .warning-box p {
      color: #fde68a;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .steps {
      list-style: none;
      margin: 1.5rem 0;
    }
    
    .step {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      color: #cbd5e1;
    }
    
    .step-number {
      flex-shrink: 0;
      width: 1.5rem;
      height: 1.5rem;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #60a5fa;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .step strong { color: white; }
    
    .btn {
      width: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      color: white;
      font-weight: 500;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.25);
      margin-top: 1.5rem;
    }
    
    .btn:hover {
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transform: scale(1.02);
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn:disabled {
      background: #334155;
      color: #64748b;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .btn-success {
      background: linear-gradient(90deg, #059669, #10b981);
      box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.25);
    }
    
    .btn-success:hover {
      background: linear-gradient(90deg, #10b981, #34d399);
      box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
    }
    
    .input-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    
    .input {
      width: 100%;
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      color: white;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    .input::placeholder {
      color: #475569;
    }
    
    .char-count {
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    
    .char-count.valid { color: #34d399; }
    .char-count.invalid { color: #64748b; }
    
    .progress-dots {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .progress-dot {
      height: 0.5rem;
      border-radius: 9999px;
      transition: all 0.3s;
    }
    
    .progress-dot.done { width: 2rem; background: #10b981; }
    .progress-dot.current { width: 3rem; background: #3b82f6; }
    .progress-dot.pending { width: 0.5rem; background: #334155; }
    
    .method-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      color: #60a5fa;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .method-description {
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .method-description p {
      font-size: 0.875rem;
    }
    
    .input-wrapper {
      position: relative;
      margin: 1rem 0;
    }
    
    .grouped-display {
      position: absolute;
      inset: 0;
      padding: 0.75rem 1rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: white;
      pointer-events: none;
      display: flex;
      align-items: center;
    }
    
    .grouped-display .char {
      display: inline;
    }
    
    .grouped-display .space {
      display: inline-block;
      width: 0.5em;
    }
    
    .grouped-display .cursor {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background: white;
      margin-left: 1px;
      animation: blink 1s step-end infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    .grouped-display .placeholder {
      color: #475569;
    }
    
    .chroma-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .chroma-container .input {
      flex: 1;
    }
    
    .color-bars {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }
    
    .color-bar {
      width: 2.5rem;
      height: 0.625rem;
      border-radius: 9999px;
      transition: background-color 0.2s;
    }
    
    .target-colors {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 0.75rem;
    }
    
    .target-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .target-bar {
      width: 2.5rem;
      height: 0.625rem;
      border-radius: 9999px;
      border: 2px solid #475569;
    }
    
    .hint {
      font-size: 0.75rem;
      color: #64748b;
      text-align: center;
      margin-top: 1rem;
    }
    
    .result-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .result-icon.success { color: #34d399; }
    .result-icon.error { color: #f87171; }
    
    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }
    
    .ranking-card {
      position: relative;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 2px solid #334155;
      background: rgba(2, 6, 23, 0.5);
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
      font-family: inherit;
      color: white;
    }
    
    .ranking-card:hover {
      border-color: #475569;
    }
    
    .ranking-card.preferred {
      background: rgba(16, 185, 129, 0.2);
      border-color: #10b981;
      box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2);
    }
    
    .ranking-card.hated {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.2);
    }
    
    .ranking-badge {
      position: absolute;
      top: -0.5rem;
      right: -0.5rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.625rem;
      font-weight: 700;
      color: white;
    }
    
    .ranking-badge.best { background: #10b981; }
    .ranking-badge.worst { background: #ef4444; }
    
    .ranking-card-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .ranking-card.preferred .ranking-card-title { color: #6ee7b7; }
    .ranking-card.hated .ranking-card-title { color: #fca5a5; }
    
    .ranking-card-desc {
      font-size: 0.75rem;
      color: #64748b;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .rating-hint {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
    }
    
    .rating-hint .best { color: #34d399; font-weight: 500; }
    .rating-hint .worst { color: #f87171; font-weight: 500; }
    
    .method-rating-card {
      padding: 1rem;
      border-radius: 0.75rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid #334155;
      margin-bottom: 1.5rem;
    }
    
    .rating-question {
      margin-bottom: 1rem;
    }
    
    .rating-question:last-child {
      margin-bottom: 0;
    }
    
    .rating-label {
      display: block;
      font-size: 0.875rem;
      color: #cbd5e1;
      margin-bottom: 0.5rem;
    }
    
    .star-buttons {
      display: flex;
      gap: 0.25rem;
    }
    
    .star-btn {
      flex: 1;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #334155;
      background: rgba(2, 6, 23, 0.5);
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .star-btn:hover {
      border-color: #475569;
    }
    
    .star-btn.selected {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    
    .scale-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.625rem;
      color: #475569;
      margin-top: 0.25rem;
    }
    
    .textarea {
      width: 100%;
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      color: white;
      font-family: inherit;
      font-size: 0.875rem;
      resize: none;
      transition: all 0.2s;
    }
    
    .textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    .textarea::placeholder {
      color: #475569;
    }
    
    .validation-hint {
      font-size: 0.75rem;
      color: #64748b;
      text-align: center;
      margin-top: 0.75rem;
    }
    
    .space-y-6 > * + * {
      margin-top: 1.5rem;
    }
    
    .space-y-4 > * + * {
      margin-top: 1rem;
    }
    
    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }
    
    .mt-4 { margin-top: 1rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Instructions Screen -->
      <div id="screen-instructions" class="screen active">
        <div class="text-center">
          <span class="badge">Passwort-Eingabe Studie</span>
          <h1>Willkommen zur Studie</h1>
        </div>
        
        <div class="warning-box">
          <p>Verwenden Sie NICHT Ihre echten Passwörter. Bitte erfinden Sie ein neues Passwort für diesen Test.</p>
        </div>
        
        <div class="space-y-4">
          <h2>Was Sie tun werden:</h2>
          <ul class="steps">
            <li class="step">
              <span class="step-number">1</span>
              <span>Erstellen Sie ein Passwort mit <strong>mehr als 15 Zeichen</strong></span>
            </li>
            <li class="step">
              <span class="step-number">2</span>
              <span>Geben Sie dasselbe Passwort <strong>4-mal</strong> mit verschiedenen Eingabe-Designs ein</span>
            </li>
            <li class="step">
              <span class="step-number">3</span>
              <span>Geben Sie am Ende kurzes Feedback</span>
            </li>
          </ul>
        </div>
        
        <p style="font-size: 0.875rem;">Diese Studie dauert ca. <strong style="color: #cbd5e1;">3-5 Minuten</strong>. Ihre Daten werden lokal gespeichert und als JSON-Datei exportiert.</p>
        
        <button class="btn" onclick="startStudy()">Studie beginnen</button>
      </div>
      
      <!-- Registration Screen -->
      <div id="screen-registration" class="screen">
        <div class="text-center">
          <h1>Erstellen Sie Ihr Passwort</h1>
          <p>Geben Sie ein Passwort ein, das Sie sich merken können. Es muss länger als 15 Zeichen sein.</p>
        </div>
        
        <div class="mt-6">
          <label class="input-label" for="register-password">Ihr Test-Passwort</label>
          <input type="password" id="register-password" class="input" placeholder="Mindestens 16 Zeichen eingeben..." autocomplete="off">
          <div id="char-count" class="char-count invalid">0 / 16+ Zeichen</div>
        </div>
        
        <button id="btn-register" class="btn" onclick="registerPassword()" disabled>Weiter</button>
      </div>
      
      <!-- Testing Screen -->
      <div id="screen-testing" class="screen">
        <div class="progress-dots" id="progress-dots"></div>
        
        <div class="text-center">
          <h1>Geben Sie Ihr Passwort erneut ein</h1>
          <span class="method-badge" id="method-badge"></span>
        </div>
        
        <div class="method-description">
          <p id="method-description"></p>
        </div>
        
        <div>
          <label class="input-label">Passwort</label>
          
          <!-- Standard Input -->
          <div id="input-standard" class="input-wrapper" style="display: none;">
            <input type="password" id="trial-input-standard" class="input" placeholder="Geben Sie Ihr Passwort ein..." autocomplete="off">
          </div>
          
          <!-- Grouped Input -->
          <div id="input-grouped" class="input-wrapper" style="display: none;">
            <input type="text" id="trial-input-grouped" class="input" style="color: transparent; caret-color: transparent;" autocomplete="off">
            <div class="grouped-display" id="grouped-display">
              <span class="placeholder">Geben Sie Ihr Passwort ein...</span>
            </div>
          </div>
          
          <!-- Last Char Input -->
          <div id="input-lastchar" class="input-wrapper" style="display: none;">
            <input type="text" id="trial-input-lastchar" class="input" style="color: transparent; caret-color: transparent;" autocomplete="off">
            <div class="grouped-display" id="lastchar-display">
              <span class="placeholder">Geben Sie Ihr Passwort ein...</span>
            </div>
          </div>
          
          <!-- Chroma Input -->
          <div id="input-chroma" style="display: none;">
            <div class="chroma-container">
              <input type="password" id="trial-input-chroma" class="input" placeholder="Geben Sie Ihr Passwort ein..." autocomplete="off">
              <div class="color-bars" id="current-colors">
                <div class="color-bar" style="background: #3f3f46;"></div>
                <div class="color-bar" style="background: #3f3f46;"></div>
                <div class="color-bar" style="background: #3f3f46;"></div>
              </div>
            </div>
            <div class="target-colors">
              <span class="target-label">Ziel</span>
              <div class="color-bars" id="target-colors">
                <div class="target-bar"></div>
                <div class="target-bar"></div>
                <div class="target-bar"></div>
              </div>
            </div>
          </div>
        </div>
        
        <p class="hint">Drücken Sie Enter oder klicken Sie auf Absenden</p>
        
        <button class="btn" onclick="submitTrial()">Absenden</button>
      </div>
      
      <!-- Result Screen -->
      <div id="screen-result" class="screen text-center">
        <div class="result-icon" id="result-icon"></div>
        <h1 id="result-title"></h1>
        <p id="result-message"></p>
        <button class="btn" onclick="nextTrial()" id="btn-next"></button>
      </div>
      
      <!-- Feedback Screen -->
      <div id="screen-feedback" class="screen">
        <div class="text-center">
          <h1>Ergebnisse & Feedback</h1>
          <p style="font-size: 0.875rem;">Bewerten Sie Ihre Erfahrung mit den verschiedenen Methoden</p>
        </div>
        
        <!-- Ranking Section -->
        <div class="mt-6">
          <h2 style="margin-bottom: 0.25rem;">Ranking</h2>
          <p class="rating-hint">Klicken Sie auf die <span class="best">beste</span> Methode (1. Klick) und dann auf die <span class="worst">schlechteste</span> Methode (2. Klick)</p>
          <div class="ranking-grid" id="ranking-grid"></div>
        </div>
        
        <!-- Per-Method Ratings -->
        <div class="mt-6">
          <h2>Bewertungen pro Methode</h2>
          <div id="method-ratings"></div>
        </div>
        
        <!-- Open Feedback -->
        <div class="mt-6">
          <label class="rating-label" for="open-feedback">Was hat Sie beim langen Passwort am meisten gestört?</label>
          <textarea id="open-feedback" class="textarea" rows="3" placeholder="Teilen Sie Ihre Gedanken..."></textarea>
        </div>
        
        <button id="btn-finish" class="btn btn-success" onclick="downloadResults()" disabled>Abschließen & Herunterladen</button>
        <p class="validation-hint" id="validation-hint">Bitte wählen Sie beste/schlechteste Methode und bewerten Sie alle Aussagen</p>
      </div>
      
      <!-- Thank You Screen -->
      <div id="screen-thanks" class="screen text-center">
        <div class="result-icon success">✓</div>
        <h1>Vielen Dank!</h1>
        <p>Ihre Studiendaten wurden heruntergeladen. Vielen Dank für Ihre Teilnahme an dieser Forschung!</p>
      </div>
    </div>
  </div>
  
  <script>
    // State
    let targetPassword = '';
    let trialOrder = [];
    let currentTrialIndex = 0;
    let studyData = { startTime: null, trials: [] };
    
    // Trial tracking
    let trialStartTime = null;
    let firstKeyTime = null;
    let keystrokeTimestamps = [];
    let backspaceCount = 0;
    let overflowDetected = false;
    let groupedRealValue = '';
    let lastCharTimeout = null;
    
    // Feedback
    let preferredMethod = null;
    let hatedMethod = null;
    let methodRatings = {
      STANDARD: { visibility: null, error_recovery: null, security: null, distraction: null },
      GROUPED: { visibility: null, error_recovery: null, security: null, distraction: null },
      LASTCHAR: { visibility: null, error_recovery: null, security: null, distraction: null },
      CHROMA: { visibility: null, error_recovery: null, security: null, distraction: null }
    };
    
    const methods = [
      { id: 'STANDARD', name: 'Standard', description: 'Ein Standard-Passwortfeld mit maskierten Zeichen.' },
      { id: 'GROUPED', name: 'Gruppierte Maskierung', description: 'Zeichen werden alle 4 Zeichen visuell gruppiert für bessere Übersicht.' },
      { id: 'LASTCHAR', name: 'Letztes Zeichen Sichtbar', description: 'Letztes Zeichen kurz sichtbar. Sofortiges Feedback (Mobile-Standard).' },
      { id: 'CHROMA', name: 'Farbfeedback', description: 'Farbige Balken als visueller Anker. Permanentes Feedback ohne Text.' }
    ];
    
    // Utility functions
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    
    function djb2Hash(str) {
      let hash = 5381;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
        hash = hash & hash;
      }
      return Math.abs(hash);
    }
    
    function hashToColors(str) {
      if (!str) return ['#3f3f46', '#3f3f46', '#3f3f46'];
      const hash1 = djb2Hash(str);
      const hash2 = djb2Hash(str + 'salt1');
      const hash3 = djb2Hash(str + 'salt2');
      return [
        `hsl(${hash1 % 360}, 70%, 60%)`,
        `hsl(${hash2 % 360}, 70%, 60%)`,
        `hsl(${hash3 % 360}, 70%, 60%)`
      ];
    }
    
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + screenId).classList.add('active');
    }
    
    // Registration
    const registerInput = document.getElementById('register-password');
    const charCount = document.getElementById('char-count');
    const btnRegister = document.getElementById('btn-register');
    
    registerInput.addEventListener('input', () => {
      const len = registerInput.value.length;
      charCount.textContent = `${len} / 16+ Zeichen`;
      charCount.className = len > 15 ? 'char-count valid' : 'char-count invalid';
      btnRegister.disabled = len <= 15;
    });
    
    registerInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && registerInput.value.length > 15) {
        registerPassword();
      }
    });
    
    function startStudy() {
      studyData.startTime = Date.now();
      showScreen('registration');
      setTimeout(() => registerInput.focus(), 100);
    }
    
    function registerPassword() {
      if (registerInput.value.length <= 15) return;
      targetPassword = registerInput.value;
      trialOrder = shuffleArray([0, 1, 2, 3]);
      currentTrialIndex = 0;
      setupTrial();
      showScreen('testing');
    }
    
    // Trial setup
    function setupTrial() {
      trialStartTime = Date.now();
      firstKeyTime = null;
      keystrokeTimestamps = [];
      backspaceCount = 0;
      overflowDetected = false;
      groupedRealValue = '';
      
      const method = methods[trialOrder[currentTrialIndex]];
      
      // Update progress dots
      const progressDots = document.getElementById('progress-dots');
      progressDots.innerHTML = [0, 1, 2, 3].map(i => {
        let cls = 'progress-dot ';
        if (i < currentTrialIndex) cls += 'done';
        else if (i === currentTrialIndex) cls += 'current';
        else cls += 'pending';
        return `<div class="${cls}"></div>`;
      }).join('');
      
      // Update method info
      document.getElementById('method-badge').textContent = `Methode ${currentTrialIndex + 1}/4: ${method.name}`;
      document.getElementById('method-description').textContent = method.description;
      
      // Hide all inputs
      ['standard', 'grouped', 'lastchar', 'chroma'].forEach(id => {
        document.getElementById('input-' + id).style.display = 'none';
      });
      
      // Show correct input
      const inputId = method.id.toLowerCase();
      document.getElementById('input-' + inputId).style.display = 'block';
      
      // Reset inputs
      document.getElementById('trial-input-standard').value = '';
      document.getElementById('trial-input-grouped').value = '';
      document.getElementById('trial-input-lastchar').value = '';
      document.getElementById('trial-input-chroma').value = '';
      document.getElementById('grouped-display').innerHTML = '<span class="placeholder">Geben Sie Ihr Passwort ein...</span>';
      document.getElementById('lastchar-display').innerHTML = '<span class="placeholder">Geben Sie Ihr Passwort ein...</span>';
      
      // Update chroma target colors
      if (method.id === 'CHROMA') {
        const targetColors = hashToColors(targetPassword);
        const targetBars = document.getElementById('target-colors').querySelectorAll('.target-bar');
        targetColors.forEach((color, i) => {
          targetBars[i].style.backgroundColor = color;
        });
        updateChromaColors('');
      }
      
      // Focus input
      setTimeout(() => {
        const input = document.getElementById('trial-input-' + inputId);
        input.focus();
      }, 100);
    }
    
    function updateChromaColors(value) {
      const colors = hashToColors(value);
      const bars = document.getElementById('current-colors').querySelectorAll('.color-bar');
      colors.forEach((color, i) => {
        bars[i].style.backgroundColor = color;
      });
    }
    
    // Event handlers for inputs
    document.getElementById('trial-input-standard').addEventListener('keydown', handleTrialKeydown);
    document.getElementById('trial-input-standard').addEventListener('input', handleTrialInput);
    
    document.getElementById('trial-input-grouped').addEventListener('keydown', handleGroupedKeydown);
    
    document.getElementById('trial-input-lastchar').addEventListener('keydown', handleTrialKeydown);
    document.getElementById('trial-input-lastchar').addEventListener('input', handleLastCharInput);
    
    document.getElementById('trial-input-chroma').addEventListener('keydown', handleTrialKeydown);
    document.getElementById('trial-input-chroma').addEventListener('input', handleChromaInput);
    
    function handleTrialKeydown(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitTrial();
        return;
      }
      
      const now = Date.now();
      if (!firstKeyTime) firstKeyTime = now;
      keystrokeTimestamps.push(now);
      
      if (e.key === 'Backspace') {
        backspaceCount++;
      }
    }
    
    function handleTrialInput(e) {
      if (e.target.value.length > targetPassword.length) {
        overflowDetected = true;
      }
    }
    
    function handleGroupedKeydown(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitTrial();
        return;
      }
      
      const now = Date.now();
      if (!firstKeyTime) firstKeyTime = now;
      keystrokeTimestamps.push(now);
      
      if (e.key === 'Backspace') {
        backspaceCount++;
        e.preventDefault();
        groupedRealValue = groupedRealValue.slice(0, -1);
        renderGroupedDisplay();
      } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        groupedRealValue += e.key;
        if (groupedRealValue.length > targetPassword.length) {
          overflowDetected = true;
        }
        renderGroupedDisplay();
      }
    }
    
    function renderGroupedDisplay() {
      const display = document.getElementById('grouped-display');
      if (groupedRealValue.length === 0) {
        display.innerHTML = '<span class="placeholder">Geben Sie Ihr Passwort ein...</span>';
        return;
      }
      
      let html = '';
      for (let i = 0; i < groupedRealValue.length; i++) {
        html += '<span class="char">•</span>';
        if ((i + 1) % 4 === 0 && i < groupedRealValue.length - 1) {
          html += '<span class="space"></span>';
        }
      }
      html += '<span class="cursor"></span>';
      display.innerHTML = html;
    }
    
    function handleLastCharInput(e) {
      const value = e.target.value;
      
      if (value.length > targetPassword.length) {
        overflowDetected = true;
      }
      
      const display = document.getElementById('lastchar-display');
      
      if (value.length === 0) {
        display.innerHTML = '<span class="placeholder">Geben Sie Ihr Passwort ein...</span>';
        return;
      }
      
      // Show dots for all but last char, last char visible
      const masked = '•'.repeat(value.length - 1) + value.slice(-1);
      display.innerHTML = `<span style="letter-spacing: 0.1em;">${masked}</span>`;
      
      // After 1 second, mask the last character too
      if (lastCharTimeout) clearTimeout(lastCharTimeout);
      lastCharTimeout = setTimeout(() => {
        display.innerHTML = `<span style="letter-spacing: 0.1em;">${'•'.repeat(value.length)}</span>`;
      }, 1000);
    }
    
    function handleChromaInput(e) {
      const value = e.target.value;
      if (value.length > targetPassword.length) {
        overflowDetected = true;
      }
      updateChromaColors(value);
    }
    
    function submitTrial() {
      const endTime = Date.now();
      const method = methods[trialOrder[currentTrialIndex]];
      
      let actualValue;
      if (method.id === 'GROUPED') {
        actualValue = groupedRealValue;
      } else if (method.id === 'LASTCHAR') {
        actualValue = document.getElementById('trial-input-lastchar').value;
      } else if (method.id === 'CHROMA') {
        actualValue = document.getElementById('trial-input-chroma').value;
      } else {
        actualValue = document.getElementById('trial-input-standard').value;
      }
      
      const success = actualValue === targetPassword;
      
      let avgInterval = null;
      if (keystrokeTimestamps.length > 1) {
        const intervals = [];
        for (let i = 1; i < keystrokeTimestamps.length; i++) {
          intervals.push(keystrokeTimestamps[i] - keystrokeTimestamps[i - 1]);
        }
        avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      }
      
      studyData.trials.push({
        method: method.id,
        success,
        durationMs: endTime - trialStartTime,
        timeToFirstKey: firstKeyTime ? firstKeyTime - trialStartTime : null,
        averageKeystrokeInterval: avgInterval,
        backspaceCount,
        overflowDetected
      });
      
      // Show result
      document.getElementById('result-icon').textContent = success ? '✓' : '✗';
      document.getElementById('result-icon').className = success ? 'result-icon success' : 'result-icon error';
      document.getElementById('result-title').textContent = success ? 'Erfolgreich!' : 'Nicht übereinstimmend';
      document.getElementById('result-message').textContent = success 
        ? 'Ihr Passwort wurde korrekt eingegeben.'
        : 'Das eingegebene Passwort stimmte nicht mit dem Original überein.';
      document.getElementById('btn-next').textContent = currentTrialIndex < 3 ? 'Nächste Aufgabe' : 'Zum Feedback';
      
      showScreen('result');
    }
    
    function nextTrial() {
      if (currentTrialIndex < 3) {
        currentTrialIndex++;
        setupTrial();
        showScreen('testing');
      } else {
        setupFeedback();
        showScreen('feedback');
      }
    }
    
    // Feedback
    function setupFeedback() {
      // Ranking grid
      const rankingGrid = document.getElementById('ranking-grid');
      rankingGrid.innerHTML = methods.map(method => `
        <button class="ranking-card" data-id="${method.id}" onclick="handleRankingClick('${method.id}')">
          <div class="ranking-card-title">${method.name}</div>
          <div class="ranking-card-desc">${method.description}</div>
        </button>
      `).join('');
      
      // Method ratings
      const questionsDE = [
        { key: 'visibility', label: 'Ich wusste immer, ob meine Eingabe registriert wurde.' },
        { key: 'error_recovery', label: 'Fehler zu korrigieren war einfach.' },
        { key: 'security', label: 'Ich fühlte mich geschützt vor neugierigen Blicken.' },
        { key: 'distraction', label: 'Die visuellen Effekte waren ablenkend.' }
      ];
      
      const methodNamesDE = {
        STANDARD: 'Standard',
        GROUPED: 'Gruppierte Maskierung',
        LASTCHAR: 'Letztes Zeichen sichtbar',
        CHROMA: 'Farbfeedback'
      };
      
      const ratingsContainer = document.getElementById('method-ratings');
      ratingsContainer.innerHTML = Object.keys(methodRatings).map(methodKey => `
        <div class="method-rating-card">
          <h3>${methodNamesDE[methodKey]}</h3>
          ${questionsDE.map(q => `
            <div class="rating-question">
              <label class="rating-label">${q.label}</label>
              <div class="star-buttons">
                ${[1,2,3,4,5].map(val => `
                  <button class="star-btn" data-method="${methodKey}" data-question="${q.key}" data-value="${val}" onclick="handleRating('${methodKey}', '${q.key}', ${val})">
                    ${'★'.repeat(val)}
                  </button>
                `).join('')}
              </div>
              <div class="scale-labels">
                <span>Stimme nicht zu</span>
                <span>Stimme voll zu</span>
              </div>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    
    function handleRankingClick(methodId) {
      if (preferredMethod === methodId) {
        preferredMethod = null;
      } else if (hatedMethod === methodId) {
        hatedMethod = null;
      } else if (!preferredMethod) {
        preferredMethod = methodId;
      } else if (!hatedMethod) {
        hatedMethod = methodId;
      }
      
      updateRankingUI();
      validateFeedback();
    }
    
    function updateRankingUI() {
      document.querySelectorAll('.ranking-card').forEach(card => {
        const id = card.dataset.id;
        card.className = 'ranking-card';
        const existingBadge = card.querySelector('.ranking-badge');
        if (existingBadge) existingBadge.remove();
        
        if (preferredMethod === id) {
          card.classList.add('preferred');
          card.querySelector('.ranking-card-title').style.color = '#6ee7b7';
          const badge = document.createElement('span');
          badge.className = 'ranking-badge best';
          badge.textContent = 'BESTE';
          card.appendChild(badge);
        } else if (hatedMethod === id) {
          card.classList.add('hated');
          card.querySelector('.ranking-card-title').style.color = '#fca5a5';
          const badge = document.createElement('span');
          badge.className = 'ranking-badge worst';
          badge.textContent = 'SCHLECHTESTE';
          card.appendChild(badge);
        } else {
          card.querySelector('.ranking-card-title').style.color = 'white';
        }
      });
    }
    
    function handleRating(methodKey, questionKey, value) {
      methodRatings[methodKey][questionKey] = value;
      
      // Update UI
      document.querySelectorAll(`.star-btn[data-method="${methodKey}"][data-question="${questionKey}"]`).forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.value) === value);
      });
      
      validateFeedback();
    }
    
    function validateFeedback() {
      const hasRanking = preferredMethod !== null && hatedMethod !== null;
      const hasAllRatings = Object.values(methodRatings).every(r => 
        r.visibility !== null && r.error_recovery !== null && r.security !== null && r.distraction !== null
      );
      
      const canFinish = hasRanking && hasAllRatings;
      document.getElementById('btn-finish').disabled = !canFinish;
      document.getElementById('validation-hint').style.display = canFinish ? 'none' : 'block';
    }
    
    function downloadResults() {
      const finalData = {
        trials: studyData.trials,
        survey: {
          preferred_method: preferredMethod,
          hated_method: hatedMethod,
          method_ratings: methodRatings,
          open_feedback: document.getElementById('open-feedback').value
        },
        endTime: Date.now()
      };
      
      const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `password-study-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showScreen('thanks');
    }
  </script>
</body>
</html>
